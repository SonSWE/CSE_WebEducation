@using CSE_WebEducation
@using ObjectInfo;
@using CommonLib;
@{
    CSE_UsersInfo _User_Info = new CSE_UsersInfo();
    if (ViewBag.User_Info != null)
    {
        _User_Info = ViewBag.User_Info;
    }
}
<div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
        <div class="header-report">
            <h3>Sửa thông tin nhóm người dùng</h3>
            <button class="btn-close" onclick="ClosePopupDialog('dPopup', false);"><img src="~/bidding_lib/img/icon-close.svg" alt="img"></button>
        </div>

        <form id="formEditUser" enctype="multipart/form-data">
            <div class="body-report">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="flex-report">
                            <div class="title-report">Tên đăng nhập <span class="clr-red">(*)</span></div>
                            <div class="field-report">
                                <input type="text" id="txtUserName" maxlength="100" name="txtUserName" autocomplete="off" value="@_User_Info.User_Name" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="flex-report">
                            <div class="title-report">Tên đầy đủ <span class="clr-red">(*)</span></div>
                            <div class="field-report">
                                <input type="text" id="txtFullname" name="txtFullname" autocomplete="off" value="@_User_Info.Full_Name" maxlength="500">
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="flex-report">
                            <div class="title-report">Loại người dùng <span class="clr-red">(*)</span></div>
                            <div class="field-report">
                                <select id="slUserType" multiple disabled>
                                    @foreach (var it in AllCodeMemory.Allcode_GetByCdnameCdtype("USER", "TYPE"))
                                    {
                                        if (@_User_Info.User_Type == Convert.ToDecimal(it.CDVal))
                                        {
                                            <option value="@it.CDVal" selected>@it.Content</option>
                                        }
                                        else
                                        {
                                            <option value="@it.CDVal">@it.Content</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="flex-report">
                            <div class="title-report">Trạng thái <span class="clr-red">(*)</span></div>
                            <div class="field-report">
                                <select id="slStatus" multiple>
                                    @foreach (var it in AllCodeMemory.Allcode_GetByCdnameCdtype("USER", "STATUS"))
                                    {
                                        if (@_User_Info.Status.ToUpper() == it.CDVal.ToUpper())
                                        {
                                            <option value="@it.CDVal" selected>@it.Content</option>
                                        }
                                        else
                                        {
                                            <option value="@it.CDVal">@it.Content</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="flex-report">
                            <div class="title-report">Email <span class="clr-red">(*)</span></div>
                            <div class="field-report">
                                <input class="ip-popup" type="text" id="txtEmail" name="txtEmail" value="@_User_Info.Email">
                            </div>
                        </div>
                    </div>


                    <div class="col-lg-12">
                        <div class="flex-report">
                            <div class="title-report">Số điện thoại</div>
                            <div class="field-report">
                                <input class="ip-popup" type="text" id="txtPhone" name="txtPhone" value="@_User_Info.Phone">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12">
                        <div class="flex-report">
                            <div class="title-report">CCCD/CMND</div>
                            <div class="field-report">
                                <input class="ip-popup" type="text" id="txtIdentityCard" name="txtIdentityCard" value="@_User_Info.Identity_Card">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="foot-report text-right">
                <input type="hidden" id="tempUserId" name="tempUserId" value="@_User_Info.User_Id" />
                <button class="btn-save" type="submit" id="btnSend"><img src="~/bidding_lib/img/icon-save.svg" alt="img">Lưu</button>
                <button class="btn-cancel" type="button" id="btnExit" onclick="ClosePopupDialog('dPopup', false);"><img src="~/bidding_lib/img/icon-cancel.svg" alt="img">Thoát</button>
            </div>
        </form>
    </div>
</div>



<script>
    $(function() {
        $('#txtFullname').focus();
    })

    var User_Id = $('#tempUserId').val();
    var Full_Name = "";
    var Email = "";
    var Phone = "";
    var IdentityCard = "";
    var status = "";

    $('#slUserType').multipleSelect({
        width: '100%',
        single: true,
        filter: true,
        placeholder: "-- Loại người dùng --",
    });

    $('#slStatus').multipleSelect({
        width: '100%',
        single: true,
        filter: true,
        placeholder: "-- Trạng thái --",
    });

    $('#formEditUser').on('submit', function (e) {
        try {

                var that = this;
                /* e = window.event || e;*/
                e.preventDefault();

                if (!validateAdd()) return false;

                var formData = new FormData();
                collectDataToAdd(formData);

                $.ajax({
                    type: "POST",
                    enctype: "multipart/form-data",
                    url: 'quan-tri/nguoi-dung/cap-nhat',
                    data: formData,
                    beforeSend: function () {
                        SpinLoading(true);
                    },
                    contentType: false, processData: false, async: false,
                    success: function (data) {
                        if (data && preHandleDataResult(data)) {
                            if (data.success > 0) {
                                showSuccess(data.responseMessage);

                                SearchUser('@CommonData.pageDefaut');
                                ClosePopupDialog('dPopup', false);
                            }
                            else {
                                showError(data.responseMessage);
                            }
                        }
                    },
                    error: function (data) {
                        console.log(data.error);
                    },
                    complete: function () {
                        SpinLoading(false);
                    }
                });

        } catch (e) {
            console.log(e);
        }

    });

    function collectDataToAdd(formData) {
        formData.append('info.User_Id', User_Id);
        formData.append('info.Full_Name', Full_Name);
        formData.append('info.Email', Email);
        formData.append('info.Phone', Phone);
        formData.append('info.Status', status);
        formData.append('info.Identity_Card', IdentityCard);
    }

    function validateAdd() {
        try {
            Full_Name = $("#txtFullname").val().trim();
            Email = $("#txtEmail").val().trim();
            status = $("#slStatus").val();

            if (Full_Name == null || Full_Name == "") {
                showError('Tên đầy đủ không được để trống')
                $("#txtFullname").focus();
                return false;
            }

            if (status == null || status == "") {
                showError('Trạng thái không được để trống')
                $("#slStatus").focus();
                return false;
            }

            if (Email == null || Email == "") {
                showError('Email không được để trống')
                $("#txtEmail").focus();
                return false;
            }

            return true;
        } catch (ex) {
            console.log(ex);
        }
    }
</script>
